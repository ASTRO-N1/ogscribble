<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>THE OG SCRIBBLE</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Segoe UI", sans-serif;
        height: 100vh;
        overflow: hidden;
        background: #0d1838;
        touch-action: none;
      }

      /* --- VIEWS --- */
      .view {
        display: none;
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        flex-direction: column;
      }
      .view.active {
        display: flex;
      }

      .icon-btn {
        width: 35px;
        height: 35px;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        cursor: pointer;
        border-radius: 4px;
        border: 2px solid transparent;
      }

      .icon-btn.active {
        border-color: #333;
        background-color: #ddd;
      }

      /* --- LANDING & LOBBY --- */
      #view-landing {
        background-color: #ffffff;
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23000000' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        align-items: center;
        justify-content: center;
      }
      .title-box {
        background: #5865f2;
        color: white;
        padding: 20px 40px;
        border-radius: 15px;
        transform: rotate(-3deg);
        margin-bottom: 40px;
        box-shadow: 5px 5px 0 #000;
        border: 3px solid #000;
      }
      h1 {
        font-size: 40px;
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 2px;
      }
      .input-group {
        display: flex;
        flex-direction: column;
        gap: 15px;
        width: 300px;
        background: white;
        padding: 20px;
        border-radius: 10px;
        border: 3px solid #000;
        box-shadow: 5px 5px 0 rgba(0, 0, 0, 0.2);
      }
      .landing-input {
        padding: 12px;
        border: 2px solid #ccc;
        border-radius: 8px;
        font-size: 16px;
        outline: none;
      }
      .btn-large {
        padding: 15px;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        border: 2px solid #000;
        color: white;
      }
      .btn-create {
        background: #2ecc71;
      }
      .btn-join {
        background: #3498db;
      }

      #view-lobby {
        justify-content: center;
        align-items: center;
        background-color: #0d1838;
        background-image: radial-gradient(#152244 15%, transparent 16%),
          radial-gradient(#152244 15%, transparent 16%);
        background-size: 60px 60px;
        background-position: 0 0, 30px 30px;
        color: #333;
      }
      .lobby-card {
        background: white;
        width: 90%;
        max-width: 500px;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      .lobby-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #ddd;
      }

      /* --- GAME LAYOUT (Desktop Default) --- */
      #game-container {
        display: flex;
        width: 100%;
        height: 100%;
        padding: 10px;
        gap: 10px;
      }

      /* Player List (Desktop) */
      #player-list {
        width: 180px;
        background: white;
        border-radius: 8px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 0;
        padding: 0;
        border: 2px solid #000;
      }
      .player-card {
        display: flex;
        align-items: center;
        padding: 5px 8px;
        border-bottom: 1px solid #eee;
        gap: 8px;
        font-size: 13px;
        height: 45px;
        background: #fff;
      }
      .player-card:nth-child(even) {
        background: #f9f9f9;
      }
      .player-card.is-drawer {
        background-color: #e0e4ff;
      }
      .player-card img {
        width: 30px;
        height: 30px;
        border-radius: 50%;
      }
      .rank-num {
        font-weight: bold;
        color: #666;
        width: 15px;
      }

      /* Middle Area */
      #middle-area {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 10px;
        position: relative;
      }
      #game-header {
        height: 50px;
        background: white;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        font-weight: bold;
        font-size: 20px;
        border: 2px solid #000;
        font-family: "Courier New", monospace;
      }
      #canvas-wrapper {
        flex-grow: 1;
        background: #fff;
        border-radius: 8px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: visible;
        border: 2px solid #000;
        box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.2);
      }
      canvas {
        background: white;
        display: block;
        cursor: crosshair;
      }

      .overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        color: white;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }

      /* Toolbar */
      #toolbar {
        position: relative;
        background: white;
        padding: 8px;
        border-radius: 8px;
        display: flex;
        gap: 15px;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 0 rgba(0, 0, 0, 0.1);
        border: 2px solid #000;
        z-index: 1000000;
      }
      .tool-btn {
        width: 35px;
        height: 35px;
        background: #eee;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        border: 2px solid transparent;
      }
      .tool-btn.active {
        border-color: #333;
        background: #ddd;
      }

      #palette {
        display: flex;
        flex-wrap: wrap;
        width: 220px;
        gap: 4px;
      }
      .swatch {
        width: 24px;
        height: 24px;
        cursor: pointer;
        border-radius: 4px;
        border: 1px solid #ccc;
      }
      #mobile-color-btn {
        display: none;
      }

      /* Chat */
      #chat-sidebar {
        width: 250px;
        background: white;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        border: 2px solid #000;
      }
      #chat-box {
        flex-grow: 1;
        padding: 10px;
        overflow-y: auto;
        font-size: 14px;
      }
      .msg {
        margin-bottom: 4px;
        word-wrap: break-word;
      }
      .msg.success {
        color: green;
        font-weight: bold;
        background: #d5f5e3;
        padding: 4px;
        border-radius: 4px;
      }
      .msg b {
        color: #333;
      }
      #chatInput {
        width: 100%;
        padding: 10px;
        border: none;
        border-top: 2px solid #eee;
        outline: none;
        font-weight: bold;
      }

      /* ========================================= */
      /* ========= MOBILE UI REFINEMENT ========= */
      /* ========================================= */
      @media (max-width: 768px) {
        #canvas-wrapper {
          box-shadow: none !important;
          border-bottom: none !important;
        }

        #toolbar {
          box-shadow: none !important;
          border-top: none !important;
          border-bottom: none !important;
        }

        #bottom-split-container {
          box-shadow: none !important;
          border-top: none !important;
        }
        #view-lobby {
          background-color: #0d1838;
          background-image: radial-gradient(#152244 15%, transparent 16%),
            radial-gradient(#152244 15%, transparent 16%);
          background-size: 60px 60px;
          background-position: 0 0, 30px 30px;

          width: 100vw;
          height: 100dvh; /* IMPORTANT */
        }
        .title-box {
          padding: 10px 20px;
          margin-bottom: 20px;
        }
        h1 {
          font-size: 22px;
          white-space: nowrap;
        }
        .icon-btn {
          width: 32px;
          height: 32px;
        }

        /* Main Flex Container: Column */
        #game-container {
          display: flex;
          flex-direction: column;
          width: 100vw;
          height: 100dvh;
          padding: 0;
          gap: 0;
        }

        /* 1. Header */
        #game-header {
          height: 45px;
          border-radius: 0;
          font-size: 16px;
          border: none;
          border-bottom: 2px solid #000;
          flex-shrink: 0;
          background: #fff;
          padding: 0 10px;
        }

        /* 2. Middle Area */
        #middle-area {
          display: contents;
        }

        #canvas-wrapper {
          width: 100%;
          height: auto;
          aspect-ratio: 4/3;
          max-height: 45vh;
          border-radius: 0;
          flex-shrink: 0;
          background: #fff;
          border: none;
          border-bottom: 2px solid #000;
          box-shadow: none;
        }
        canvas {
          width: 100% !important;
          height: 100% !important;
        }

        /* 3. Toolbar */
        #toolbar {
          width: 100%;
          height: 45px;
          border-radius: 0;
          padding: 5px;
          overflow-x: auto;
          justify-content: space-between;
          border: none;
          border-bottom: 2px solid #000;
          flex-shrink: 0;
          background: #eee;
        }
        #palette-container {
          position: static;
        }
        #palette {
          position: fixed; /* CHANGE THIS from absolute */
          top: auto; /* Reset the negative top */
          bottom: 80px; /* Position it nicely above the toolbar */
          left: 50%;
          transform: translateX(-50%);
          background: white;
          border: 2px solid #000;
          padding: 6px;
          border-radius: 8px;
          z-index: 2000000; /* Ensure it sits on top of everything */
          display: none;
        }
        #palette.show {
          display: flex;
        }
        #mobile-color-btn {
          display: block;
          width: 32px;
          height: 32px;
          border: 2px solid #000;
          cursor: pointer;
          border-radius: 4px;
        }

        /* 4. Bottom Split Section (Players + Chat) */
        #bottom-split-container {
          display: flex;
          flex-grow: 1;
          min-height: 0;
          background: white;
          overflow: hidden;
        }

        /* Left: Player List - INCREASED WIDTH (40%) */
        #player-list {
          width: 40%; /* Wider as requested */
          height: 100%;
          border: none;
          border-right: 2px solid #000;
          background: #f1f1f1;
          padding: 0;
          gap: 0;
        }
        /* Strip Design */
        .player-card {
          border-radius: 0;
          background: white;
          border-bottom: 1px solid #ddd;
          padding: 0 5px;
          height: 40px; /* Slightly taller for better touch */
          display: flex;
          flex-direction: row;
          align-items: center;
          justify-content: flex-start;
          gap: 5px;
          font-size: 12px;
          width: 100%;
        }
        .rank-num {
          font-size: 12px;
          width: 15px;
          text-align: center;
        }
        .player-card img {
          width: 28px;
          height: 28px;
          margin: 0;
        }
        .player-info {
          display: flex;
          flex-direction: column;
          justify-content: center;
          line-height: 1.1;
          overflow: hidden;
          white-space: nowrap;
          flex: 1;
        }
        .player-name {
          font-weight: bold;
          text-overflow: ellipsis;
          overflow: hidden;
        }
        .player-score {
          font-size: 10px;
          color: #666;
        }

        /* Right: Chat Section (60%) */
        #chat-sidebar {
          width: 60%;
          flex: 1;
          height: 100%;
          border: none;
          border-radius: 0;
          background: white;
        }
        #chat-box {
          flex-grow: 1;
          overflow-y: auto;
          padding: 5px;
          font-size: 13px;
          background: #fff;
        }
        #chat-box .msg:nth-child(even) {
          background: #f8f8f8;
        }

        #chatInput {
          flex-shrink: 0;
          height: 40px;
          border-top: 2px solid #000;
          padding: 0 10px;
          font-size: 14px;
        }

        .tool-btn {
          width: 32px;
          height: 32px;
          font-size: 16px;
        }
        .word-btn {
          padding: 6px 12px;
          font-size: 14px;
          border: 2px solid #000;
        }
      }
    </style>
  </head>
  <body>
    <div id="view-landing" class="view active">
      <div class="title-box"><h1>THE OG SCRIBBLE</h1></div>
      <div class="input-group">
        <input
          type="text"
          id="username"
          class="landing-input"
          placeholder="Your Name"
        />
        <button class="btn-large btn-create" onclick="createRoom()">
          CREATE ROOM
        </button>
        <div style="display: flex; gap: 5px">
          <input
            type="number"
            id="room-code-input"
            class="landing-input"
            placeholder="Code"
            style="width: 100px"
          />
          <button
            class="btn-large btn-join"
            style="flex-grow: 1"
            onclick="joinRoom()"
          >
            JOIN
          </button>
        </div>
      </div>
    </div>

    <div id="view-lobby" class="view">
      <div class="lobby-card">
        <h2 style="text-align: center; margin: 0">LOBBY</h2>
        <div
          style="
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 5px;
            background: #eee;
            padding: 10px;
          "
          id="lobby-code"
        ></div>
        <div id="host-settings" style="display: none">
          <div
            style="
              display: flex;
              justify-content: space-between;
              margin: 10px 0;
            "
          >
            <label>Rounds:</label>
            <select id="rounds-select" onchange="updateSettings()">
              <option value="3">3</option>
              <option value="5">5</option>
              <option value="7">7</option>
            </select>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              margin: 10px 0;
            "
          >
            <label>Draw Time:</label>
            <select id="time-select" onchange="updateSettings()">
              <option value="30">30s</option>
              <option value="60" selected>60s</option>
              <option value="90">90s</option>
            </select>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              margin: 10px 0;
            "
          >
            <label>Hints:</label>
            <select id="hints-select" onchange="updateSettings()">
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3" selected>3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
          <button
            class="btn-large btn-create"
            style="width: 100%; margin-top: 15px"
            onclick="socket.emit('start-game', {code: currentCode})"
          >
            START GAME
          </button>
        </div>
        <div
          id="guest-msg"
          style="text-align: center; color: #666; display: none"
        >
          Waiting for host...
        </div>
        <div
          id="player-list-lobby"
          style="
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
          "
        ></div>
      </div>
    </div>

    <div id="view-game" class="view">
      <div id="game-container">
        <div id="game-header"></div>

        <div id="middle-area">
          <div id="canvas-wrapper">
            <canvas id="canvas"></canvas>
            <div id="overlay-waiting" class="overlay">
              <h1>Waiting for drawer...</h1>
            </div>
            <div id="overlay-select" class="overlay">
              <h1>CHOOSE WORD</h1>
              <div id="word-options" style="display: flex; gap: 10px"></div>
            </div>
            <div id="overlay-result" class="overlay">
              <h1 id="result-title"></h1>
              <div id="result-content"></div>
            </div>
          </div>

          <div id="toolbar">
            <div
              id="mobile-color-btn"
              style="background: black"
              onclick="togglePalette()"
            ></div>
            <div id="palette-container"><div id="palette"></div></div>

            <div
              style="
                display: flex;
                gap: 5px;
                align-items: center;
                border-left: 1px solid #ccc;
                padding-left: 10px;
              "
            >
              <div
                class="size-btn"
                onclick="setSize(4)"
                style="
                  width: 25px;
                  height: 25px;
                  background: #eee;
                  border-radius: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  cursor: pointer;
                "
              >
                <div
                  style="
                    width: 4px;
                    height: 4px;
                    background: black;
                    border-radius: 50%;
                  "
                ></div>
              </div>
              <div
                class="size-btn"
                onclick="setSize(10)"
                style="
                  width: 25px;
                  height: 25px;
                  background: #eee;
                  border-radius: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  cursor: pointer;
                "
              >
                <div
                  style="
                    width: 10px;
                    height: 10px;
                    background: black;
                    border-radius: 50%;
                  "
                ></div>
              </div>
              <div
                class="size-btn"
                onclick="setSize(20)"
                style="
                  width: 25px;
                  height: 25px;
                  background: #eee;
                  border-radius: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  cursor: pointer;
                "
              >
                <div
                  style="
                    width: 18px;
                    height: 18px;
                    background: black;
                    border-radius: 50%;
                  "
                ></div>
              </div>
            </div>

            <div
              style="
                display: flex;
                gap: 5px;
                align-items: center;
                border-left: 1px solid #ccc;
                padding-left: 10px;
              "
            >
              <div
                class="icon-btn active"
                id="btn-pen"
                style="background-image: url('/img/pen.gif')"
                onclick="setTool('pen')"
              ></div>

              <div
                class="icon-btn"
                id="btn-fill"
                style="background-image: url('/img/fill.gif')"
                onclick="setTool('fill')"
              ></div>

              <div
                class="icon-btn"
                style="background-image: url('/img/undo.gif')"
                onclick="undoLast()"
              ></div>

              <div
                class="icon-btn"
                style="background-image: url('/img/clear.gif')"
                onclick="clearBoard()"
              ></div>
            </div>
          </div>
        </div>

        <div id="bottom-split-container">
          <div id="player-list"></div>
          <div id="chat-sidebar">
            <div id="chat-box"></div>
            <input
              type="text"
              id="chatInput"
              placeholder="Type guess..."
              autocomplete="off"
            />
          </div>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      let currentCode = null,
        myId = null,
        isDrawer = false;
      let revealedWord = null;

      // --- CANVAS SETUP ---
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d", { willReadFrequently: true });
      const GAME_W = 800,
        GAME_H = 600;
      canvas.width = GAME_W;
      canvas.height = GAME_H;

      function resetCanvas() {
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, GAME_W, GAME_H);
      }
      resetCanvas();

      // --- STATE ---
      let drawing = false,
        currentTool = "pen",
        myColor = "black",
        mySize = 5;
      let currentStrokeId = null; // New for Undo Fix

      const colors = [
        "#000000",
        "#555555",
        "#ffffff",
        "#ef130b",
        "#ff7100",
        "#ffe400",
        "#00cc00",
        "#00b2ff",
        "#231fd3",
        "#a300ba",
        "#d37caa",
        "#a0522d",
      ];
      const pDiv = document.getElementById("palette");
      colors.forEach((c) => {
        const d = document.createElement("div");
        d.className = "swatch";
        d.style.background = c;
        d.onclick = () => {
          myColor = c;
          document.getElementById("mobile-color-btn").style.background = c;
          setTool(currentTool === "eraser" ? "pen" : currentTool);
          document.getElementById("palette").classList.remove("show");
        };
        pDiv.appendChild(d);
      });

      function togglePalette() {
        document.getElementById("palette").classList.toggle("show");
      }
      function undoLast() {
        if (isDrawer) socket.emit("undo");
      }

      // --- SOCKETS ---
      socket.on("connect", () => {
        myId = socket.id;
        if (currentCode) socket.emit("request-state");
      });

      function showView(id) {
        document
          .querySelectorAll(".view")
          .forEach((v) => v.classList.remove("active"));
        document.getElementById(id).classList.add("active");
        if (id === "view-game") setTimeout(resize, 100);
      }

      function createRoom() {
        const name = document.getElementById("username").value || "Host";
        socket.emit("create-room", { name });
      }
      function joinRoom() {
        const name = document.getElementById("username").value || "Guest";
        const code = document.getElementById("room-code-input").value;
        if (code) socket.emit("join-room", { code, name });
      }
      function renderWord(revealed) {
        if (!revealed) return "";
        return revealed.map((c) => (c === null ? "_" : c)).join(" ");
      }

      socket.on("hint-update", ({ revealed }) => {
        revealedWord = revealed;

        if (isDrawer) return;

        const header = document.getElementById("game-header");
        if (!header) return;

        const wordDiv = header.querySelector(".word-display");
        if (wordDiv) {
          wordDiv.innerText = renderWord(revealedWord);
        }
      });

      socket.on("room-joined", ({ code, isHost, settings }) => {
        currentCode = code;
        document.getElementById("lobby-code").innerText = code;
        document.getElementById("host-settings").style.display = isHost
          ? "block"
          : "none";
        document.getElementById("guest-msg").style.display = isHost
          ? "none"
          : "block";
        showView("view-lobby");
        document.getElementById("rounds-select").value = settings.rounds;
        document.getElementById("time-select").value = settings.drawTime;
      });
      socket.on("restore-snapshot", (dataURL) => {
        const img = new Image();
        img.onload = () => {
          resetCanvas();
          ctx.drawImage(img, 0, 0);
        };
        img.src = dataURL;

        // Request authoritative state after snapshot restore
        socket.emit("request-state");
      });

      socket.on("player-update", ({ users, host }) => {
        document.getElementById("player-list-lobby").innerHTML = users
          .map(
            (u) =>
              `<div style="text-align:center;"><img src="${u.avatar}" class="lobby-avatar"><br>${u.name}</div>`
          )
          .join("");

        // Game View List (Horizontal Rectangles)
        const listHTML = users
          .sort((a, b) => b.score - a.score)
          .map(
            (u, i) => `
            <div class="player-card ${u.id === drawerId ? "is-drawer" : ""}">
                <div class="rank-num">#${i + 1}</div>
                <img src="${u.avatar}">
                <div class="player-info">
                    <div class="player-name">${u.name}</div>
                    <div class="player-score">${u.score} pts</div>
                </div>
            </div>`
          )
          .join("");
        document.getElementById("player-list").innerHTML = listHTML;
      });

      socket.on("settings-update", (s) => {
        document.getElementById("rounds-select").value = s.rounds;
        document.getElementById("time-select").value = s.drawTime;

        const hintsSel = document.getElementById("hints-select");
        if (hintsSel) {
          hintsSel.value = s.maxHints;
        }
      });

      function updateSettings() {
        const rounds = parseInt(document.getElementById("rounds-select").value);
        const drawTime = parseInt(document.getElementById("time-select").value);
        const maxHints = parseInt(
          document.getElementById("hints-select").value
        );

        socket.emit("update-settings", {
          code: currentCode,
          settings: { rounds, drawTime, maxHints },
        });
      }

      let drawerId = null;
      socket.on("game-update", (game) => {
        if (game.status === "selecting" || game.status === "lobby") {
          revealedWord = null;
        }

        if (game.status === "lobby") {
          showView("view-lobby");
          return;
        }
        showView("view-game");

        drawerId = game.drawerId;
        isDrawer = myId === drawerId;

        // Visual Toolbar handling
        document.getElementById("toolbar").style.display = isDrawer
          ? "flex"
          : "none";

        // Ensure Bottom section fills space if toolbar is hidden
        const bottomSection = document.getElementById("bottom-split-container");
        if (!isDrawer) bottomSection.style.height = "calc(100vh - 45px - 45vh)";

        document
          .querySelectorAll(".overlay")
          .forEach((o) => (o.style.display = "none"));
        const header = document.getElementById("game-header");

        let headerHTML = `<div style="display:flex; align-items:center; gap:5px;">⏱️ <span id="time-display">${
          game.time || 0
        }</span></div>`;

        if (game.status === "selecting") {
          headerHTML += `<div>${game.drawer} choosing...</div>`;
          if (!isDrawer) {
            document.getElementById("overlay-waiting").style.display = "flex";
            document
              .getElementById("overlay-waiting")
              .querySelector("h1").innerText = `${game.drawer} is choosing...`;
          }
        } else if (game.status === "drawing") {
          const wordHTML = isDrawer
            ? game.word
            : `<span class="word-display">${
                revealedWord
                  ? renderWord(revealedWord)
                  : game.word.replace(/[a-zA-Z]/g, "_ ")
              }</span>`;

          headerHTML += `<div style="font-size:1.2em; letter-spacing:2px;">${wordHTML}</div>`;
        }
        headerHTML += `<div>Rd ${game.round}/${game.maxRounds}</div>`;
        header.innerHTML = headerHTML;

        if (game.status === "result" || game.status === "game-over") {
          document.getElementById("overlay-result").style.display = "flex";
          document.getElementById("result-title").innerText =
            game.status === "game-over" ? "GAME OVER" : `Word: ${game.word}`;
          let html =
            '<div style="background:white; color:black; padding:20px; border-radius:10px;">';
          game.scores.forEach(
            (u, i) => (html += `<div>${i + 1}. ${u.name}: ${u.score}</div>`)
          );
          document.getElementById("result-content").innerHTML = html + "</div>";
        }
      });

      socket.on("choose-word", (words) => {
        const div = document.getElementById("word-options");
        div.innerHTML = "";
        document.getElementById("overlay-select").style.display = "flex";
        words.forEach((w) => {
          const btn = document.createElement("button");
          btn.innerText = w;
          btn.className = "word-btn";
          btn.onclick = () => {
            socket.emit("word-selected", w);
            document.getElementById("overlay-select").style.display = "none";
          };
          div.appendChild(btn);
        });
      });

      socket.on("timer", (t) => {
        const el = document.getElementById("time-display");
        if (el) el.innerText = t;
      });

      // --- DRAWING ---
      function resize() {
        const wrapper = document.getElementById("canvas-wrapper");
        canvas.style.width = "100%";
        canvas.style.height = "100%";
      }
      window.addEventListener("resize", resize);

      function getPos(e) {
        const r = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return {
          x: (clientX - r.left) * (GAME_W / r.width),
          y: (clientY - r.top) * (GAME_H / r.height),
        };
      }

      function start(e) {
        if (!isDrawer) return;
        if (e.cancelable) e.preventDefault();
        const p = getPos(e);

        // Generate Stroke ID for Undo
        currentStrokeId =
          Date.now() + "-" + Math.random().toString(36).substr(2, 9);

        if (currentTool === "fill") {
          const snapshot = canvas.toDataURL("image/png");

          socket.emit("fill", {
            x: p.x,
            y: p.y,
            color: myColor,
            strokeId: currentStrokeId,
            snapshot: snapshot,
          });

          floodFill(Math.floor(p.x), Math.floor(p.y), myColor);
          return;
        }

        drawing = true;
        lastX = p.x;
        lastY = p.y;
      }
      let lastX = 0,
        lastY = 0;
      function move(e) {
        if (!drawing || !isDrawer) return;
        if (e.cancelable) e.preventDefault();
        const p = getPos(e);
        const col = currentTool === "eraser" ? "#ffffff" : myColor;
        const size = currentTool === "eraser" ? 20 : mySize;
        drawLine(lastX, lastY, p.x, p.y, col, size);

        // Send strokeId with every point
        socket.emit("draw", {
          x0: lastX,
          y0: lastY,
          x1: p.x,
          y1: p.y,
          color: col,
          size,
          strokeId: currentStrokeId,
        });

        lastX = p.x;
        lastY = p.y;
      }
      function end() {
        if (drawing) {
          drawing = false;
        }
      }

      ["mousedown", "touchstart"].forEach((e) =>
        canvas.addEventListener(e, start, { passive: false })
      );
      ["mousemove", "touchmove"].forEach((e) =>
        canvas.addEventListener(e, move, { passive: false })
      );
      ["mouseup", "touchend"].forEach((e) => canvas.addEventListener(e, end));

      function drawLine(x0, y0, x1, y1, c, s) {
        ctx.beginPath();
        ctx.moveTo(x0, y0);
        ctx.lineTo(x1, y1);
        ctx.strokeStyle = c;
        ctx.lineWidth = s;
        ctx.lineCap = "round";
        ctx.stroke();
      }
      function floodFill(sx, sy, hex) {
        const r = parseInt(hex.slice(1, 3), 16),
          g = parseInt(hex.slice(3, 5), 16),
          b = parseInt(hex.slice(5, 7), 16);
        const imgD = ctx.getImageData(0, 0, GAME_W, GAME_H),
          d = imgD.data;
        const st = (sy * GAME_W + sx) * 4,
          sr = d[st],
          sg = d[st + 1],
          sb = d[st + 2];
        if (sr === r && sg === g && sb === b) return;
        const stack = [[sx, sy]];
        while (stack.length) {
          const [x, y] = stack.pop();
          let ptr = (y * GAME_W + x) * 4;
          let y1 = y;
          while (
            y1 >= 0 &&
            d[ptr] === sr &&
            d[ptr + 1] === sg &&
            d[ptr + 2] === sb
          ) {
            y1--;
            ptr -= GAME_W * 4;
          }
          ptr += GAME_W * 4;
          y1++;
          let sl = false,
            sr_flag = false;
          while (
            y1 < GAME_H &&
            d[ptr] === sr &&
            d[ptr + 1] === sg &&
            d[ptr + 2] === sb
          ) {
            d[ptr] = r;
            d[ptr + 1] = g;
            d[ptr + 2] = b;
            d[ptr + 3] = 255;
            if (x > 0 && d[ptr - 4] === sr) {
              if (!sl) stack.push([x - 1, y1]);
              sl = true;
            } else sl = false;
            if (x < GAME_W - 1 && d[ptr + 4] === sr) {
              if (!sr_flag) stack.push([x + 1, y1]);
              sr_flag = true;
            } else sr_flag = false;
            y1++;
            ptr += GAME_W * 4;
          }
        }
        ctx.putImageData(imgD, 0, 0);
      }

      socket.on("draw", (d) =>
        drawLine(d.x0, d.y0, d.x1, d.y1, d.color, d.size)
      );
      socket.on("fill", (d) =>
        floodFill(Math.floor(d.x), Math.floor(d.y), d.color)
      );
      socket.on("clear", () => resetCanvas());
      socket.on("history", (h) => {
        resetCanvas();
        h.forEach((d) => {
          if (d.type === "fill") {
            floodFill(Math.floor(d.x), Math.floor(d.y), d.color);
          } else {
            drawLine(d.x0, d.y0, d.x1, d.y1, d.color, d.size);
          }
        });
      });

      // --- CHAT ---
      const chatIn = document.getElementById("chatInput");
      const chatBox = document.getElementById("chat-box");
      chatIn.onkeydown = (e) => {
        if (e.key === "Enter" && chatIn.value) {
          socket.emit("chat", chatIn.value);
          chatIn.value = "";
        }
      };
      socket.on("chat", (msg) => {
        chatBox.innerHTML += `<div class="msg ${msg.type}"><b>${msg.player}:</b> ${msg.msg}</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
      });

      function setTool(t) {
        currentTool = t;

        document
          .querySelectorAll(".icon-btn")
          .forEach((b) => b.classList.remove("active"));

        const btn = document.getElementById(`btn-${t}`);
        if (btn) btn.classList.add("active");
      }

      function setSize(s) {
        mySize = s;
      }
      function clearBoard() {
        if (isDrawer) socket.emit("clear");
      }
    </script>
  </body>
</html>
