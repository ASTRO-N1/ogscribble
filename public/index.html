<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>THE OG SCRIBBLE</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Segoe UI", sans-serif;
        height: 100vh;
        overflow: hidden;
        background: #5865f2;
        touch-action: none;
      }

      /* --- VIEWS --- */
      .view {
        display: none;
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        flex-direction: column;
      }
      .view.active {
        display: flex;
      }

      /* --- LANDING PAGE --- */
      #view-landing {
        background-color: #ffffff;
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23000000' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        align-items: center;
        justify-content: center;
      }
      .title-box {
        background: #5865f2;
        color: white;
        padding: 20px 40px;
        border-radius: 15px;
        transform: rotate(-3deg);
        margin-bottom: 40px;
        box-shadow: 5px 5px 0 #000;
        border: 3px solid #000;
      }
      h1 {
        font-size: 40px;
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 2px;
      }

      .input-group {
        display: flex;
        flex-direction: column;
        gap: 15px;
        width: 300px;
        background: white;
        padding: 20px;
        border-radius: 10px;
        border: 3px solid #000;
        box-shadow: 5px 5px 0 rgba(0, 0, 0, 0.2);
      }
      .landing-input {
        padding: 12px;
        border: 2px solid #ccc;
        border-radius: 8px;
        font-size: 16px;
        outline: none;
      }
      .landing-input:focus {
        border-color: #5865f2;
      }
      .btn-large {
        padding: 15px;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.1s;
        border: 2px solid #000;
        color: white;
      }
      .btn-create {
        background: #2ecc71;
      }
      .btn-join {
        background: #3498db;
      }
      .btn-large:active {
        transform: translateY(2px);
      }

      /* --- LOBBY --- */
      #view-lobby {
        background: #5865f2;
        align-items: center;
        padding: 20px;
      }
      .lobby-card {
        background: white;
        width: 90%;
        max-width: 500px;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      .room-code-display {
        font-size: 24px;
        text-align: center;
        background: #eee;
        padding: 10px;
        border-radius: 5px;
        font-weight: bold;
        letter-spacing: 5px;
      }
      .setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
      }
      select {
        padding: 5px;
        font-size: 16px;
        border-radius: 4px;
        border: 1px solid #ccc;
      }

      #player-list-lobby {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin-top: 10px;
      }
      .lobby-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #ddd;
        border: 2px solid #fff;
      }

      /* --- GAME VIEW --- */
      #view-game {
        flex-direction: column;
      }
      #game-container {
        display: flex;
        width: 100%;
        height: 100%;
        padding: 10px;
        gap: 10px;
      }

      #player-list {
        width: 180px;
        background: white;
        border-radius: 8px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 5px;
        padding: 5px;
      }
      .player-card {
        display: flex;
        align-items: center;
        padding: 5px;
        background: #eee;
        border-radius: 4px;
        gap: 8px;
      }
      .player-card.is-drawer {
        border: 2px solid #5865f2;
        background: #e0e4ff;
      }
      .player-card.is-host {
        border-left: 4px solid gold;
      }
      .player-card img {
        width: 30px;
        height: 30px;
        border-radius: 50%;
      }

      #middle-area {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 10px;
        position: relative;
      }
      #game-header {
        height: 40px;
        background: white;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        font-weight: bold;
      }

      /* CANVAS WRAPPER - CENTERED */
      #canvas-wrapper {
        flex-grow: 1;
        background: #444;
        border-radius: 8px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }

      canvas {
        background: white;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        touch-action: none;
        cursor: crosshair;
        display: block;
        /* WIDTH/HEIGHT SET BY JS FOR PERFECT RATIO */
      }

      .overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 100;
        text-align: center;
        display: none;
      }

      /* --- PRO TOOLBAR --- */
      #toolbar {
        background: white;
        padding: 8px;
        border-radius: 8px;
        display: flex;
        gap: 15px;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 0 rgba(0, 0, 0, 0.1);
      }

      .tool-btn {
        width: 35px;
        height: 35px;
        background: #eee;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        border: 2px solid transparent;
      }
      .tool-btn.active {
        border-color: #333;
        background: #ddd;
        transform: translateY(2px);
      }

      .size-btn {
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border-radius: 50%;
      }
      .dot {
        background: black;
        border-radius: 50%;
        pointer-events: none;
      }

      /* Palette */
      #palette-container {
        position: relative;
      }
      #palette {
        display: flex;
        flex-wrap: wrap;
        width: 220px;
        gap: 4px;
      }
      .swatch {
        width: 24px;
        height: 24px;
        cursor: pointer;
        border-radius: 4px;
        border: 1px solid rgba(0, 0, 0, 0.2);
      }
      .swatch:hover {
        transform: scale(1.1);
      }

      #mobile-color-btn {
        display: none;
        width: 35px;
        height: 35px;
        border: 2px solid #333;
        border-radius: 4px;
        cursor: pointer;
      }

      /* Chat */
      #chat-sidebar {
        width: 250px;
        background: white;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
      }
      #chat-box {
        flex-grow: 1;
        padding: 10px;
        overflow-y: auto;
        background: #f9f9f9;
      }
      .msg {
        margin-bottom: 4px;
        font-size: 13px;
        word-wrap: break-word;
      }
      .msg.success {
        color: green;
        font-weight: bold;
        background: #d5f5e3;
        padding: 4px;
        border-radius: 4px;
      }
      #chatInput {
        width: 100%;
        padding: 10px;
        border: none;
        border-top: 1px solid #eee;
      }

      /* Mobile Tweaks */
      @media (max-width: 768px) {
        #game-container {
          flex-direction: column;
          padding: 5px;
        }
        .title-box {
          padding: 10px 20px; /* Reduce padding so text has more room */
          margin-bottom: 30px;
        }
        h1 {
          font-size: 30px; /* Make text smaller to fit on one line */
          white-space: nowrap; /* Force it to stay on one line */
        }
        #player-list {
          width: 100%;
          height: 50px;
          flex-direction: row;
          overflow-x: auto;
          order: 1;
        }
        #game-header {
          order: 2;
          height: 30px;
          font-size: 12px;
        }
        #middle-area {
          order: 3;
        }
        #canvas-wrapper {
          max-height: 50vh;
        }
        #toolbar {
          order: 4;
          justify-content: space-between;
          padding: 5px;
        }
        #chat-sidebar {
          width: 100%;
          height: 150px;
          order: 5;
        }

        #palette {
          display: none;
          position: absolute;
          bottom: 50px;
          left: 0;
          background: white;
          padding: 10px;
          border-radius: 8px;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
          z-index: 101;
          width: 200px;
        }
        #palette.show {
          display: flex;
        }
        #mobile-color-btn {
          display: block;
        }
      }

      .word-btn {
        padding: 10px 20px;
        margin: 5px;
        background: white;
        color: black;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 18px;
        font-weight: bold;
      }
      .word-btn:hover {
        background: #ddd;
      }
    </style>
  </head>
  <body>
    <div id="view-landing" class="view active">
      <div class="title-box"><h1>THE OG SCRIBBLE</h1></div>
      <div class="input-group">
        <input
          type="text"
          id="username"
          class="landing-input"
          placeholder="Enter Your Name"
        />
        <button class="btn-large btn-create" onclick="createRoom()">
          CREATE ROOM
        </button>
        <div style="display: flex; gap: 5px">
          <input
            type="number"
            id="room-code-input"
            class="landing-input"
            placeholder="Code"
            style="width: 100px"
          />
          <button
            class="btn-large btn-join"
            style="flex-grow: 1"
            onclick="joinRoom()"
          >
            JOIN
          </button>
        </div>
      </div>
    </div>

    <div id="view-lobby" class="view">
      <div class="lobby-card">
        <h2 style="margin: 0; text-align: center">LOBBY</h2>
        <div class="room-code-display" id="lobby-code">CODE: -----</div>

        <div id="host-settings" style="display: none">
          <div class="setting-row">
            <label>Rounds:</label>
            <select id="rounds-select" onchange="updateSettings()">
              <option value="3">3</option>
              <option value="5">5</option>
              <option value="7">7</option>
            </select>
          </div>
          <div class="setting-row">
            <label>Draw Time:</label>
            <select id="time-select" onchange="updateSettings()">
              <option value="30">30s</option>
              <option value="60" selected>60s</option>
              <option value="90">90s</option>
            </select>
          </div>
          <button
            class="btn-large btn-create"
            style="width: 100%; margin-top: 10px"
            onclick="socket.emit('start-game', {code: currentCode})"
          >
            START GAME
          </button>
        </div>
        <div
          id="guest-msg"
          style="text-align: center; color: #666; display: none"
        >
          Waiting for host...
        </div>
        <div id="player-list-lobby"></div>
      </div>
    </div>

    <div id="view-game" class="view">
      <div id="game-container">
        <div id="player-list"></div>
        <div id="middle-area">
          <div id="game-header"></div>
          <div id="canvas-wrapper">
            <canvas id="canvas"></canvas>
            <div id="overlay-waiting" class="overlay">
              <h1>Waiting for drawer...</h1>
            </div>
            <div id="overlay-select" class="overlay">
              <h1>CHOOSE WORD</h1>
              <div id="word-options" style="display: flex; gap: 10px"></div>
            </div>
            <div id="overlay-result" class="overlay">
              <h1 id="result-title"></h1>
              <div id="result-content"></div>
            </div>
          </div>

          <div id="toolbar">
            <div
              id="mobile-color-btn"
              style="background: black"
              onclick="togglePalette()"
            ></div>

            <div id="palette-container">
              <div id="palette"></div>
            </div>

            <div
              style="
                display: flex;
                gap: 5px;
                border-left: 1px solid #ccc;
                padding-left: 10px;
              "
            >
              <div class="size-btn" onclick="setSize(4)">
                <div class="dot" style="width: 5px; height: 5px"></div>
              </div>
              <div class="size-btn" onclick="setSize(10)">
                <div class="dot" style="width: 10px; height: 10px"></div>
              </div>
              <div class="size-btn" onclick="setSize(20)">
                <div class="dot" style="width: 18px; height: 18px"></div>
              </div>
            </div>

            <div
              style="
                display: flex;
                gap: 5px;
                border-left: 1px solid #ccc;
                padding-left: 10px;
              "
            >
              <div
                class="tool-btn active"
                id="btn-pen"
                onclick="setTool('pen')"
              >
                ‚úèÔ∏è
              </div>
              <div class="tool-btn" id="btn-fill" onclick="setTool('fill')">
                ü™£
              </div>
              <div class="tool-btn" id="btn-eraser" onclick="setTool('eraser')">
                üßº
              </div>
              <div
                class="tool-btn"
                style="background: #ffcccc"
                onclick="clearBoard()"
              >
                üóëÔ∏è
              </div>
            </div>
          </div>
        </div>
        <div id="chat-sidebar">
          <div id="chat-box"></div>
          <input type="text" id="chatInput" placeholder="Guess here..." />
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      let currentCode = null;
      let myName = "";
      let amHost = false;
      let myId = null;

      // --- CANVAS SETUP & RESOLUTION FIX ---
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d", { willReadFrequently: true });
      // FIXED RESOLUTION: Game logic runs at 800x600.
      const GAME_W = 800;
      const GAME_H = 600;
      canvas.width = GAME_W;
      canvas.height = GAME_H;

      // --- FIX: INITIALIZE WHITE BACKGROUND ---
      function resetCanvas() {
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, GAME_W, GAME_H);
      }
      resetCanvas();

      // --- STATE ---
      let drawing = false,
        currentTool = "pen",
        myColor = "black",
        mySize = 5;

      // --- PALETTE ---
      const colors = [
        "#000000",
        "#555555",
        "#ffffff",
        "#ef130b",
        "#ff7100",
        "#ffe400",
        "#00cc00",
        "#00b2ff",
        "#231fd3",
        "#a300ba",
        "#d37caa",
        "#a0522d",
      ];
      const paletteDiv = document.getElementById("palette");
      colors.forEach((c) => {
        const d = document.createElement("div");
        d.className = "swatch";
        d.style.background = c;
        d.onclick = () => {
          myColor = c;
          document.getElementById("mobile-color-btn").style.background = c;
          setTool(currentTool === "eraser" ? "pen" : currentTool);
          if (window.innerWidth <= 768)
            document.getElementById("palette").classList.remove("show");
        };
        paletteDiv.appendChild(d);
      });

      function togglePalette() {
        document.getElementById("palette").classList.toggle("show");
      }

      // --- VIEW SWITCHER ---
      function showView(id) {
        document
          .querySelectorAll(".view")
          .forEach((v) => v.classList.remove("active"));
        document.getElementById(id).classList.add("active");
        if (id === "view-game") {
          setTimeout(resize, 50);
          setTimeout(resize, 500); // Safety resize
        }
      }

      // --- LOBBY ACTIONS ---
      function createRoom() {
        const name = document.getElementById("username").value || "Host";
        myName = name;
        localStorage.setItem("scribble_name", name);
        socket.emit("create-room", { name });
      }
      function joinRoom() {
        const name = document.getElementById("username").value || "Guest";
        const code = document.getElementById("room-code-input").value;
        if (!code) return alert("Enter a code!");
        myName = name;
        localStorage.setItem("scribble_name", name);
        socket.emit("join-room", { code, name });
      }

      // --- SOCKET LISTENERS ---
      socket.on("connect", () => {
        myId = socket.id;
      });

      socket.on("room-joined", ({ code, isHost, settings }) => {
        currentCode = code;
        amHost = isHost;
        document.getElementById("lobby-code").innerText = `CODE: ${code}`;
        showView("view-lobby");
        document.getElementById("host-settings").style.display = isHost
          ? "block"
          : "none";
        document.getElementById("guest-msg").style.display = isHost
          ? "none"
          : "block";
        document.getElementById("rounds-select").value = settings.rounds;
        document.getElementById("time-select").value = settings.drawTime;
      });

      socket.on("player-update", ({ users, host }) => {
        document.getElementById("player-list-lobby").innerHTML = users
          .map(
            (u) =>
              `<div style="text-align:center;"><img src="${u.avatar}" class="lobby-avatar"><br>${u.name}</div>`
          )
          .join("");
        document.getElementById("player-list").innerHTML = users
          .sort((a, b) => b.score - a.score)
          .map(
            (u) => `
            <div class="player-card ${u.id === host ? "is-host" : ""} ${
              u.id === drawerId ? "is-drawer" : ""
            }">
                <img src="${u.avatar}"><div><b>${u.name}</b><br>${
              u.score
            } pts</div>
            </div>`
          )
          .join("");
      });

      socket.on("settings-update", (s) => {
        document.getElementById("rounds-select").value = s.rounds;
        document.getElementById("time-select").value = s.drawTime;
      });

      function updateSettings() {
        if (!amHost) return;
        const rounds = parseInt(document.getElementById("rounds-select").value);
        const drawTime = parseInt(document.getElementById("time-select").value);
        socket.emit("update-settings", {
          code: currentCode,
          settings: { rounds, drawTime },
        });
      }

      // --- GAME LOGIC ---
      let drawerId = null;
      let isDrawer = false;

      socket.on("game-update", (game) => {
        if (game.status === "lobby") {
          showView("view-lobby");
          return;
        }

        showView("view-game");
        const header = document.getElementById("game-header");
        if (game.round)
          header.innerHTML = `Round ${game.round}/${game.maxRounds} <span id="timer"></span>`;

        drawerId = game.drawerId;
        isDrawer = myId === drawerId;

        document
          .querySelectorAll(".overlay")
          .forEach((o) => (o.style.display = "none"));

        if (game.status === "selecting") {
          document.getElementById(
            "game-header"
          ).innerHTML += ` | ${game.drawer} IS CHOOSING...`;
          if (!isDrawer) {
            document.getElementById("overlay-waiting").style.display = "flex";
            document
              .getElementById("overlay-waiting")
              .querySelector("h1").innerText = `${game.drawer} is choosing...`;
          }
        } else if (game.status === "drawing") {
          if (isDrawer) header.innerHTML += ` | DRAW: ${game.word}`;
          else header.innerHTML += ` | GUESS: ${game.drawer} is drawing`;
        } else if (game.status === "result" || game.status === "game-over") {
          document.getElementById("overlay-result").style.display = "flex";
          document.getElementById("result-title").innerText =
            game.status === "game-over"
              ? "GAME OVER"
              : `Word was: ${game.word}`;
          let html =
            '<div style="background:white; color:black; padding:20px; border-radius:10px;">';
          game.scores.forEach(
            (u, i) => (html += `<div>${i + 1}. ${u.name}: ${u.score}</div>`)
          );
          html += "</div>";
          document.getElementById("result-content").innerHTML = html;
        }
      });

      socket.on("choose-word", (words) => {
        document.getElementById("overlay-select").style.display = "flex";
        const div = document.getElementById("word-options");
        div.innerHTML = "";
        words.forEach((w) => {
          const btn = document.createElement("button");
          btn.className = "word-btn";
          btn.innerText = w;
          btn.onclick = () => {
            socket.emit("word-selected", w);
            document.getElementById("overlay-select").style.display = "none";
          };
          div.appendChild(btn);
        });
      });

      socket.on("timer", (t) => {
        if (document.getElementById("timer"))
          document.getElementById("timer").innerText = ` ‚è±Ô∏è ${t}`;
      });

      // --- DRAWING LOGIC (SMART RESIZE) ---
      function resize() {
        const wrapper = document.getElementById("canvas-wrapper");
        const availW = wrapper.clientWidth;
        const availH = wrapper.clientHeight;
        const targetRatio = GAME_W / GAME_H;
        const availRatio = availW / availH;

        let finalW, finalH;
        if (availRatio > targetRatio) {
          finalH = availH;
          finalW = finalH * targetRatio;
        } else {
          finalW = availW;
          finalH = finalW / targetRatio;
        }
        canvas.style.width = `${finalW}px`;
        canvas.style.height = `${finalH}px`;
      }
      window.addEventListener("resize", resize);

      function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const scaleX = GAME_W / rect.width;
        const scaleY = GAME_H / rect.height;
        return {
          x: (clientX - rect.left) * scaleX,
          y: (clientY - rect.top) * scaleY,
        };
      }

      function start(e) {
        if (!isDrawer) return;
        if (e.cancelable) e.preventDefault();

        const p = getPos(e);

        if (currentTool === "fill") {
          socket.emit("fill", { x: p.x, y: p.y, color: myColor });
          floodFill(Math.floor(p.x), Math.floor(p.y), myColor);
          sendSync();
          return;
        }
        drawing = true;
        lastX = p.x;
        lastY = p.y;
      }

      let lastX = 0,
        lastY = 0;
      function move(e) {
        if (!drawing || !isDrawer) return;
        if (e.cancelable) e.preventDefault();

        const p = getPos(e);
        const col = currentTool === "eraser" ? "#ffffff" : myColor;
        const size = currentTool === "eraser" ? 20 : mySize;

        drawLine(lastX, lastY, p.x, p.y, col, size);
        socket.emit("draw", {
          x0: lastX,
          y0: lastY,
          x1: p.x,
          y1: p.y,
          color: col,
          size,
        });
        lastX = p.x;
        lastY = p.y;
      }
      function end() {
        if (drawing) {
          drawing = false;
          sendSync(); // SNAPSHOT SYNC
        }
      }

      // --- NUCLEAR SYNC ---
      function sendSync() {
        if (!isDrawer) return;
        const img = canvas.toDataURL("image/jpeg", 0.5);
        socket.emit("sync-board", img);
      }
      socket.on("sync-board", (imgData) => {
        const img = new Image();
        img.onload = () => ctx.drawImage(img, 0, 0);
        img.src = imgData;
      });

      ["mousedown", "touchstart"].forEach((e) =>
        canvas.addEventListener(e, start, { passive: false })
      );
      ["mousemove", "touchmove"].forEach((e) =>
        canvas.addEventListener(e, move, { passive: false })
      );
      ["mouseup", "touchend"].forEach((e) => canvas.addEventListener(e, end));

      function drawLine(x0, y0, x1, y1, c, s) {
        ctx.beginPath();
        ctx.moveTo(x0, y0);
        ctx.lineTo(x1, y1);
        ctx.strokeStyle = c;
        ctx.lineWidth = s;
        ctx.lineCap = "round";
        ctx.stroke();
      }

      function floodFill(sx, sy, hex) {
        const r = parseInt(hex.slice(1, 3), 16),
          g = parseInt(hex.slice(3, 5), 16),
          b = parseInt(hex.slice(5, 7), 16);
        const imgD = ctx.getImageData(0, 0, GAME_W, GAME_H),
          d = imgD.data;
        const st = (sy * GAME_W + sx) * 4;
        const sr = d[st],
          sg = d[st + 1],
          sb = d[st + 2];
        if (sr === r && sg === g && sb === b) return;
        const stack = [[sx, sy]];
        while (stack.length) {
          const [x, y] = stack.pop();
          let ptr = (y * GAME_W + x) * 4;
          let y1 = y;
          while (
            y1 >= 0 &&
            d[ptr] === sr &&
            d[ptr + 1] === sg &&
            d[ptr + 2] === sb
          ) {
            y1--;
            ptr -= GAME_W * 4;
          }
          ptr += GAME_W * 4;
          y1++;
          let sl = false,
            sr_flag = false;
          while (
            y1 < GAME_H &&
            d[ptr] === sr &&
            d[ptr + 1] === sg &&
            d[ptr + 2] === sb
          ) {
            d[ptr] = r;
            d[ptr + 1] = g;
            d[ptr + 2] = b;
            d[ptr + 3] = 255;
            if (x > 0 && d[ptr - 4] === sr) {
              if (!sl) stack.push([x - 1, y1]);
              sl = true;
            } else sl = false;
            if (x < GAME_W - 1 && d[ptr + 4] === sr) {
              if (!sr_flag) stack.push([x + 1, y1]);
              sr_flag = true;
            } else sr_flag = false;
            y1++;
            ptr += GAME_W * 4;
          }
        }
        ctx.putImageData(imgD, 0, 0);
      }

      // Socket Events
      socket.on("draw", (d) =>
        drawLine(d.x0, d.y0, d.x1, d.y1, d.color, d.size)
      );
      socket.on("fill", (d) =>
        floodFill(Math.floor(d.x), Math.floor(d.y), d.color)
      );
      socket.on("clear", () => resetCanvas());
      socket.on("history", (h) =>
        h.forEach((d) =>
          d.type === "fill"
            ? floodFill(Math.floor(d.x), Math.floor(d.y), d.color)
            : drawLine(d.x0, d.y0, d.x1, d.y1, d.color, d.size)
        )
      );

      // Chat
      const chatIn = document.getElementById("chatInput");
      const chatBox = document.getElementById("chat-box");
      chatIn.onkeydown = (e) => {
        if (e.key === "Enter" && chatIn.value) {
          socket.emit("chat", chatIn.value);
          chatIn.value = "";
        }
      };
      socket.on("chat", (msg) => {
        chatBox.innerHTML += `<div class="msg ${msg.type}"><b>${msg.player}:</b> ${msg.msg}</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
      });

      // UI Helpers
      function setTool(t) {
        currentTool = t;
        document
          .querySelectorAll(".tool-btn")
          .forEach((b) => b.classList.remove("active"));
        document.getElementById(`btn-${t}`).classList.add("active");
      }
      function setSize(s) {
        mySize = s;
      }
      function clearBoard() {
        if (isDrawer) socket.emit("clear");
      }
    </script>
  </body>
</html>
